<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Producto â€” MiTienda</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- ===================== HEADER ===================== -->
  <header class="site-header">
    <div class="container nav-bar">
      <a class="brand" href="./" aria-label="Ir al inicio">
        <img src="assets/LogoTienda/LogoHuertoHogar.png" alt="MiTienda" class="logo-img" />
        <span>MiTienda</span>
      </a>

      <nav class="primary-nav" aria-label="Principal">
        <ul class="menu">
          <li><a href="./">Inicio</a></li>
          <li><a href="./productos.html" aria-current="page">Productos</a></li>
          <li><a href="./blogs.html">Blogs</a></li>
          <li><a href="./contacto.html">Contacto</a></li>
        </ul>
      </nav>

      <div class="actions">
        <button class="btn-icon" type="button" aria-label="Abrir carrito"> 
          ðŸ›’ <span class="badge" id="cart-count" aria-live="polite">0</span>
        </button>
        <div class="account-buttons">
          <a href="./login.html">Iniciar sesiÃ³n</a> |
          <a href="./registro.html">Registrar usuario</a>
        </div>
      </div>
    </div>
  </header>

  <!-- ===================== CARRITO ===================== -->
  <aside id="cart-panel" class="cart-panel hidden" aria-labelledby="cart-title">
    <h2 id="cart-title">Tu carrito</h2>
    <div id="cart-feedback" class="cart-feedback" role="status" aria-live="polite"></div>
    <ul id="cart-items"></ul>
    <p id="cart-total">Total: $0</p>
    <div class="cart-actions-row">
      <button id="close-cart" type="button" class="btn-primary">Cerrar</button>
    </div>
  </aside>

  <!-- ===================== MAIN ===================== -->
  <main id="contenido" class="product-detail">
    <div class="container wide">
      <nav class="breadcrumb" aria-label="breadcrumbs">
        <a href="./">Inicio</a> â€º <a href="./productos.html">Productos</a> â€º <span id="bc-name">Producto</span>
      </nav>

      <div class="pd-grid">
        <!-- GalerÃ­a -->
        <section class="product-gallery" aria-label="GalerÃ­a">
          <div class="main" id="pd-main"></div>
          <div class="product-thumbs" id="pd-thumbs" aria-label="Miniaturas"></div>
        </section>

        <!-- Info -->
        <section class="product-info">
          <h1 id="pd-name">Nombre Producto</h1>

          <div class="rating-row" id="pd-rating-row">
            <span class="star-rating" id="pd-stars" style="--rating:0"></span>
            <span id="pd-rating-text">0.0 Â· 0 reseÃ±as</span>
          </div>

          <div class="meta">
            <span class="price-lg" id="pd-price"></span>
            <span class="unit" id="pd-unit"></span>
          </div>

          <p class="desc" id="pd-desc"></p>

          <dl class="facts">
            <div><dt>Origen</dt><dd id="pd-origen">â€”</dd></div>
            <div><dt>Stock</dt><dd id="pd-stock">â€”</dd></div>
            <div>
              <dt>PrÃ¡cticas</dt>
              <dd>
                <ul id="pd-practicas-list" class="cert-list" aria-label="PrÃ¡cticas y certificaciones"></ul>
              </dd>
            </div>
            <div>
              <dt>Recetas</dt>
              <dd>
                <ul id="pd-recetas-list" class="recetas-list"></ul>
              </dd>
            </div>
          </dl>

          <div class="qty-row">
            <label for="pd-qty">Cantidad</label>
            <input id="pd-qty" type="number" min="1" value="1" inputmode="numeric">
            <button id="pd-add" class="btn-primary" type="button">AÃ±adir al carrito</button>

            <!-- â¬‡â¬‡ NUEVO: botÃ³n de receta â¬‡â¬‡ -->
            <a id="pd-recipe-btn"
               class="btn-outline"
               href="#"
               target="_blank"
               rel="noopener"
               aria-label="Ver receta relacionada">
              Ver receta
            </a>
          </div>

          <!-- Compartir -->
          <div class="share-row" style="margin-top:.75rem;">
            <button id="pd-share" class="btn-outline" type="button"
                    aria-haspopup="menu" aria-expanded="false" aria-controls="share-menu">
              Compartir
            </button>
            <ul id="share-menu" class="share-menu" role="menu"
                style="display:none; margin:.5rem 0 0; padding:.5rem; border:1px solid var(--border); border-radius:10px; background:var(--surface);">
            </ul>
          </div>
        </section>
      </div>

      <!-- Relacionados -->
      <section class="related">
        <h2>Productos relacionados</h2>
        <div class="related-grid" id="related-grid"></div>
      </section>
    </div>
  </main>

  <!-- ===================== FOOTER ===================== -->
  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <h4>MiTienda</h4>
        <p>Calidad, cercanÃ­a y buenos precios.</p>
      </div>
      <div>
        <h4>NavegaciÃ³n</h4>
        <nav aria-label="Enlaces de pie">
          <ul class="menu" style="flex-direction:column; gap:.25rem">
            <li><a href="./">Inicio</a></li>
            <li><a href="./productos.html">Productos</a></li>
            <li><a href="./blogs.html">Blogs</a></li>
            <li><a href="./contacto.html">Contacto</a></li>
          </ul>
        </nav>
      </div>
      <div>
        <h4>Contacto</h4>
        <p>contacto@mitienda.cl<br/>+56 9 1234 5678</p>
      </div>
    </div>
  </footer>

  <!-- ===================== SCRIPTS ===================== -->
  <script type="module" src="js/script.js"></script>

  <!-- LÃ“GICA DE DETALLE -->
  <script type="module">
    import { PRODUCTS_HH } from './js/productos_huerto.js';

    const qs = new URLSearchParams(location.search);
    const code = qs.get('code');

    const fmtCLP = n => n.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
    const $ = s => document.querySelector(s);

    // GalerÃ­a
    const main   = $('#pd-main');
    const thumbs = $('#pd-thumbs');

    // Info
    const nameEl = $('#pd-name');
    const bcName = $('#bc-name');
    const price  = $('#pd-price');
    const unit   = $('#pd-unit');
    const desc   = $('#pd-desc');
    const origen = $('#pd-origen');
    const stock  = $('#pd-stock');
    const qtyInp = $('#pd-qty');
    const addBtn = $('#pd-add');

    // NUEVO: botÃ³n de receta
    const recipeBtn = document.getElementById('pd-recipe-btn');

    // Rating
    const starsEl    = $('#pd-stars');
    const ratingText = $('#pd-rating-text');

    // Recetas
    const recetasList = document.getElementById('pd-recetas-list');

    // Relacionados
    const relatedGrid = $('#related-grid');

    // Compartir
    const shareBtn  = $('#pd-share');
    const shareMenu = $('#share-menu');

    const p = PRODUCTS_HH.find(x => x.code === code) || PRODUCTS_HH[0];

    if (!p) {
      document.querySelector('.product-detail .container').innerHTML =
        '<p class="muted">Producto no encontrado.</p>';
    } else {
      // Datos principales
      nameEl.textContent = p.nombre;
      if (bcName) bcName.textContent = p.nombre;
      price.textContent  = fmtCLP(p.precioCLP);
      unit.textContent   = ` / ${p.unidad}`;
      desc.textContent   = p.descripcion;
      origen.textContent = p.origen || 'â€”';
      stock.textContent  = typeof p.stock === 'number' ? p.stock : 'â€”';

      // BotÃ³n segÃºn stock
      if (typeof p.stock === 'number' && p.stock <= 0) {
        addBtn.disabled = true;
        addBtn.textContent = 'Sin stock';
        qtyInp.disabled = true;
      }

      // Alerta stock crÃ­tico
      const stockCritico = Number(p.stockCritico ?? NaN);
      if (!Number.isNaN(stockCritico) && typeof p.stock === 'number' && p.stock < stockCritico) {
        const warn = document.createElement('p');
        warn.className = 'stock-alert';
        warn.textContent = `âš  Quedan pocas unidades (${p.stock})`;
        document.querySelector('.facts')?.after(warn);
      }

      // PrÃ¡cticas / certificaciones
      const practList = document.getElementById('pd-practicas-list');
      if (Array.isArray(p.practicas) && p.practicas.length){
        practList.innerHTML = p.practicas.map(item => `
          <li>
            <svg class="ico" viewBox="0 0 20 20" aria-hidden="true" focusable="false">
              <path fill="currentColor" d="M7.8 14.3L3.5 10l1.4-1.4 2.9 2.9 7.3-7.3 1.4 1.4-8.7 8.7z"/>
            </svg>
            <span class="text">${item}</span>
          </li>
        `).join('');
      } else {
        practList.innerHTML = `<li><span class="text">â€”</span></li>`;
      }

      // ===== Recetas (URLs externas seguras) =====
      function isSafeUrl(href) {
        try {
          const url = new URL(String(href), location.href);
          return url.protocol === 'https:' || url.protocol === 'http:';
        } catch { return false; }
      }
      function getHrefAndTitle(item, idx) {
        if (typeof item === 'string') return { href: item, title: `Receta ${idx + 1}` };
        if (item && typeof item === 'object' && item.href)
          return { href: String(item.href), title: String(item.titulo || `Receta ${idx + 1}`) };
        return null;
      }

      // BotÃ³n "Ver receta" (usa la primera receta vÃ¡lida)
      const firstRecipe = (() => {
        const src = Array.isArray(p.recetas) ? p.recetas : [];
        for (let i = 0; i < src.length; i++) {
          const entry = getHrefAndTitle(src[i], i);
          if (entry && isSafeUrl(entry.href)) return entry;
        }
        return null;
      })();

      if (recipeBtn) {
        if (firstRecipe) {
          recipeBtn.href = firstRecipe.href;
          recipeBtn.setAttribute('aria-label', `Ver receta relacionada de ${p.nombre}`);
          recipeBtn.style.display = '';
        } else {
          // si no hay recetas vÃ¡lidas, ocultamos el botÃ³n
          recipeBtn.style.display = 'none';
        }
      }

      // Listado de recetas
      (function renderRecetas() {
        const src = Array.isArray(p.recetas) ? p.recetas : [];
        const cleaned = src
          .map((it, i) => getHrefAndTitle(it, i))
          .filter(Boolean)
          .filter(({ href }) => isSafeUrl(href));

        if (!cleaned.length) {
          recetasList.innerHTML = `<li>â€”</li>`;
          return;
        }
        recetasList.innerHTML = cleaned.map(({ href, title }) => `
          <li>
            <a href="${href}" target="_blank" rel="noopener" class="recipe-link">${title}</a>
          </li>
        `).join('');
      })();
      // ===== /Recetas =====

      // Rating
      const rating  = Number(p.rating ?? 0);
      const reviews = Number(p.reviews ?? 0);
      starsEl.style.setProperty('--rating', String(rating));
      ratingText.textContent = `${rating.toFixed(1)} Â· ${reviews} ${reviews === 1 ? 'reseÃ±a' : 'reseÃ±as'}`;
      starsEl.setAttribute('title', `${rating.toFixed(1)} de 5`);

      // GalerÃ­a
      const gal = Array.isArray(p.galeria) && p.galeria.length ? p.galeria : [p.imagen];
      function setMain(src){
        main.innerHTML = `<img src="${src}" alt="${p.nombre}" loading="eager" style="width:100%;height:100%;object-fit:contain;">`;
      }
      setMain(gal[0]);
      thumbs.innerHTML = '';
      gal.forEach((src, i) => {
        const b = document.createElement('button');
        b.className = 'thumb-btn';
        b.innerHTML = `<img src="${src}" alt="Vista ${i+1}" loading="lazy">`;
        b.addEventListener('click', () => setMain(src));
        thumbs.appendChild(b);
      });

      // AÃ±adir al carrito con cantidad (usa listener global de script.js)
      addBtn.dataset.code = p.code;
      addBtn.dataset.qty  = '1';
      qtyInp.addEventListener('input', () => {
        const q = Math.max(1, parseInt(qtyInp.value || '1', 10));
        qtyInp.value = q;
        addBtn.dataset.qty = String(q);
      });

      // Relacionados
      const relacionados = PRODUCTS_HH
        .filter(x => x.categoriaId === p.categoriaId && x.code !== p.code)
        .slice(0, 5);

      relatedGrid.innerHTML = '';
      relacionados.forEach(r => {
        const a = document.createElement('a');
        a.className = 'related-card';
        a.href = `./producto.html?code=${r.code}`;
        a.innerHTML = `
          <div class="thumb"><img src="${r.imagen}" alt="${r.nombre}"></div>
          <span class="title">${r.nombre}</span>
          <div class="rating-row" title="${(r.rating ?? 0).toFixed(1)} de 5">
            <span class="star-rating" style="--rating:${r.rating ?? 0}"></span>
            <span>${(r.rating ?? 0).toFixed(1)} Â· ${r.reviews ?? 0}</span>
          </div>
          <span class="price">${fmtCLP(r.precioCLP)}</span>
        `;
        relatedGrid.appendChild(a);
      });

      // ====== COMPARTIR ======
      if (shareBtn && shareMenu) {
        const url  = location.href;
        const text = `${p.nombre} â€” ${fmtCLP(p.precioCLP)} / ${p.unidad}`;
        const enc = encodeURIComponent;

        const links = [
          { href: `https://api.whatsapp.com/send?text=${enc(text + ' ' + url)}`,  label: 'WhatsApp' },
          { href: `https://www.facebook.com/sharer/sharer.php?u=${enc(url)}`,      label: 'Facebook' },
          { href: `https://twitter.com/intent/tweet?text=${enc(text)}&url=${enc(url)}`, label: 'X / Twitter' }
        ];
        shareMenu.innerHTML = `
          ${links.map(l => `
            <li role="none">
              <a role="menuitem" href="${l.href}" target="_blank" rel="noopener" class="share-link" style="display:block;padding:.4rem .6rem;border-radius:8px;">
                ${l.label}
              </a>
            </li>
          `).join('')}
          <li role="none">
            <button id="copy-link" role="menuitem" class="btn-outline" type="button" style="margin-top:.25rem;">
              Copiar enlace
            </button>
          </li>
        `;

        const openMenu  = () => { shareMenu.style.display = 'block'; shareMenu.classList.add('open'); shareBtn.setAttribute('aria-expanded','true'); };
        const closeMenu = () => { shareMenu.style.display = 'none';  shareMenu.classList.remove('open'); shareBtn.setAttribute('aria-expanded','false'); };

        shareBtn.addEventListener('click', async () => {
          if (navigator.share) {
            try { await navigator.share({ title: p.nombre, text: p.descripcion || text, url }); }
            catch { /* cancelado */ }
          } else {
            if (shareMenu.classList.contains('open')) closeMenu(); else openMenu();
          }
        });

        shareMenu.addEventListener('click', async (e) => {
          const btn = e.target.closest('#copy-link');
          if (!btn) return;
          try {
            await navigator.clipboard.writeText(url);
            btn.textContent = 'Â¡Enlace copiado!';
            setTimeout(() => (btn.textContent = 'Copiar enlace'), 1200);
          } catch {}
        });

        document.addEventListener('click', (e) => {
          if (!shareMenu.classList.contains('open')) return;
          const inMenu = shareMenu.contains(e.target);
          const onBtn  = shareBtn.contains(e.target);
          if (!inMenu && !onBtn) closeMenu();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && shareMenu.classList.contains('open')) closeMenu();
        });
      }
      // ====== /COMPARTIR ======
    }
  </script>
</body>
</html>
