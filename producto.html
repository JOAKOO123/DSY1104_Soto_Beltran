<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Producto â€” MiTienda</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- ===================== HEADER ===================== -->
  <header class="site-header">
    <div class="container nav-bar">
      <a class="brand" href="./" aria-label="Ir al inicio">
        <img src="assets/LogoTienda/LogoHuertoHogar.png" alt="MiTienda" class="logo-img" />
        <span>MiTienda</span>
      </a>

      <nav class="primary-nav" aria-label="Principal">
        <ul class="menu">
          <li><a href="./">Inicio</a></li>
          <li><a href="./productos.html" aria-current="page">Productos</a></li>
          <li><a href="./blogs.html">Blogs</a></li>
          <li><a href="./contacto.html">Contacto</a></li>
        </ul>
      </nav>

      <div class="actions">
        <button class="btn-icon" type="button" aria-label="Abrir carrito"> 
          ðŸ›’ <span class="badge" id="cart-count" aria-live="polite">0</span>
        </button>
        <div class="account-buttons">
          <a href="./login.html">Iniciar sesiÃ³n</a> |
          <a href="./registro.html">Registrar usuario</a>
        </div>
      </div>
    </div>
  </header>

  <!-- ===================== CARRITO ===================== -->
  <aside id="cart-panel" class="cart-panel hidden" aria-labelledby="cart-title">
    <h2 id="cart-title">Tu carrito</h2>
    <div id="cart-feedback" class="cart-feedback" role="status" aria-live="polite"></div>
    <ul id="cart-items"></ul>
    <p id="cart-total">Total: $0</p>
    <div class="cart-actions-row">
      <button id="close-cart" type="button" class="btn-primary">Cerrar</button>
    </div>
  </aside>

  <!-- ===================== MAIN ===================== -->
  <main id="contenido" class="product-detail">
    <div class="container wide">
      <nav class="breadcrumb" aria-label="breadcrumbs">
        <a href="./">Inicio</a> â€º <a href="./productos.html">Productos</a> â€º <span id="bc-name">Producto</span>
      </nav>

      <div class="pd-grid" style="display:grid;grid-template-columns:1.1fr .9fr;gap:1.5rem;align-items:start;">
        <!-- GalerÃ­a -->
        <section class="product-gallery" aria-label="GalerÃ­a">
          <div class="main" id="pd-main"
               style="aspect-ratio:4/3;border-radius:12px;border:1px solid var(--border);overflow:hidden;background:var(--surface);display:grid;place-items:center;">
          </div>
          <div class="product-thumbs" id="pd-thumbs" aria-label="Miniaturas"
               style="margin-top:.6rem;display:flex;gap:.5rem;flex-wrap:wrap;"></div>
        </section>

        <!-- Info -->
        <section class="product-info">
          <h1 id="pd-name" style="margin:.25rem 0 .5rem;">Nombre Producto</h1>

          <div class="rating-row" id="pd-rating-row" style="margin:.1rem 0 .75rem;">
            <span class="star-rating" id="pd-stars" style="--rating:0"></span>
            <span id="pd-rating-text">0.0 Â· 0 reseÃ±as</span>
          </div>

          <div class="meta" style="margin:.25rem 0 1rem;">
            <span class="price-lg" id="pd-price" style="font-size:1.35rem;font-weight:800;"></span>
            <span class="unit" id="pd-unit" style="color:var(--muted);margin-left:.25rem;"></span>
          </div>

          <p class="desc" id="pd-desc" style="margin:.5rem 0 1rem;"></p>

          <dl class="facts" style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem 1rem;margin:0 0 1rem;">
            <div><dt style="font-weight:700;">Origen</dt><dd id="pd-origen">â€”</dd></div>
            <div><dt style="font-weight:700;">Stock</dt><dd id="pd-stock">â€”</dd></div>
            <div>
              <dt style="font-weight:700;">PrÃ¡cticas</dt>
              <dd>
                <ul id="pd-practicas-list" class="cert-list" aria-label="PrÃ¡cticas y certificaciones"></ul>
              </dd>
            </div>
            <div><dt style="font-weight:700;">Recetas</dt><dd id="pd-recetas">â€”</dd></div>
          </dl>

          <div class="qty-row" style="display:flex;gap:.5rem;align-items:center;">
            <label for="pd-qty" style="font-weight:700;">Cantidad</label>
            <input id="pd-qty" type="number" min="1" value="1" inputmode="numeric" style="width:90px;">
            <button id="pd-add" class="btn-primary" type="button">AÃ±adir al carrito</button>
          </div>
        </section>
      </div>

      <!-- Relacionados -->
      <section class="related" style="margin-top:2rem;">
        <h2>Productos relacionados</h2>
        <div class="related-grid" id="related-grid"></div>
      </section>
    </div>
  </main>

  <!-- ===================== FOOTER ===================== -->
  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <h4>MiTienda</h4>
        <p>Calidad, cercanÃ­a y buenos precios.</p>
      </div>
      <div>
        <h4>NavegaciÃ³n</h4>
        <nav aria-label="Enlaces de pie">
          <ul class="menu" style="flex-direction:column; gap:.25rem">
            <li><a href="./">Inicio</a></li>
            <li><a href="./productos.html">Productos</a></li>
            <li><a href="./blogs.html">Blogs</a></li>
            <li><a href="./contacto.html">Contacto</a></li>
          </ul>
        </nav>
      </div>
      <div>
        <h4>Contacto</h4>
        <p>contacto@mitienda.cl<br/>+56 9 1234 5678</p>
      </div>
    </div>
  </footer>

  <!-- ===================== SCRIPTS ===================== -->
  <script type="module" src="js/script.js"></script>

  <script type="module">
    import { PRODUCTS_HH } from './js/productos_huerto.js';

    const qs = new URLSearchParams(location.search);
    const code = qs.get('code');
    const fmtCLP = n => n.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
    const $ = s => document.querySelector(s);

    const main = $('#pd-main');
    const thumbs = $('#pd-thumbs');
    const nameEl = $('#pd-name');
    const bcName = $('#bc-name');
    const price = $('#pd-price');
    const unit = $('#pd-unit');
    const desc = $('#pd-desc');
    const origen = $('#pd-origen');
    const stock = $('#pd-stock');
    const recetas = $('#pd-recetas');
    const qtyInp = $('#pd-qty');
    const addBtn = $('#pd-add');
    const starsEl = $('#pd-stars');
    const ratingText = $('#pd-rating-text');
    const relatedGrid = $('#related-grid');

    const p = PRODUCTS_HH.find(x => x.code === code) || PRODUCTS_HH[0];

    if (!p) {
      document.querySelector('.product-detail .container').innerHTML =
        '<p class="muted">Producto no encontrado.</p>';
    } else {
      nameEl.textContent = p.nombre;
      if (bcName) bcName.textContent = p.nombre;
      price.textContent = fmtCLP(p.precioCLP);
      unit.textContent = ` / ${p.unidad}`;
      desc.textContent = p.descripcion;
      origen.textContent = p.origen || 'â€”';
      stock.textContent = typeof p.stock === 'number' ? p.stock : 'â€”';

      // ðŸ”¸ Deshabilitar botÃ³n si stock = 0
      if (typeof p.stock === 'number' && p.stock <= 0) {
        addBtn.disabled = true;
        addBtn.textContent = 'Sin stock';
        qtyInp.disabled = true;
      }

      // ðŸ”¸ Mostrar alerta si stock < stockCrÃ­tico
      const stockCritico = Number(p.stockCritico ?? NaN);
      if (!Number.isNaN(stockCritico) && typeof p.stock === 'number' && p.stock < stockCritico) {
        const warn = document.createElement('p');
        warn.className = 'stock-alert';
        warn.textContent = `âš  Quedan pocas unidades (${p.stock})`;
        document.querySelector('.facts')?.after(warn);
      }

      const practList = document.getElementById('pd-practicas-list');
      if (Array.isArray(p.practicas) && p.practicas.length) {
        practList.innerHTML = p.practicas.map(item => `
          <li>
            <svg class="ico" viewBox="0 0 20 20" aria-hidden="true" focusable="false">
              <path fill="currentColor" d="M7.8 14.3L3.5 10l1.4-1.4 2.9 2.9 7.3-7.3 1.4 1.4-8.7 8.7z"/>
            </svg>
            <span class="text">${item}</span>
          </li>
        `).join('');
      } else {
        practList.innerHTML = `<li><span class="text">â€”</span></li>`;
      }

      recetas.innerHTML = Array.isArray(p.recetas) && p.recetas.length
        ? `<a href="${p.recetas[0]}" target="_blank" rel="noopener">Ver receta</a>`
        : 'â€”';

      const rating = Number(p.rating ?? 0);
      const reviews = Number(p.reviews ?? 0);
      starsEl.style.setProperty('--rating', String(rating));
      ratingText.textContent = `${rating.toFixed(1)} Â· ${reviews} ${reviews === 1 ? 'reseÃ±a' : 'reseÃ±as'}`;
      starsEl.setAttribute('title', `${rating.toFixed(1)} de 5`);

      const gal = Array.isArray(p.galeria) && p.galeria.length ? p.galeria : [p.imagen];
      function setMain(src) {
        main.innerHTML = `<img src="${src}" alt="${p.nombre}" loading="eager" style="width:100%;height:100%;object-fit:contain;">`;
      }
      setMain(gal[0]);
      thumbs.innerHTML = '';
      gal.forEach((src, i) => {
        const b = document.createElement('button');
        b.className = 'thumb-btn';
        b.style.cssText = 'width:70px;height:70px;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--surface);';
        b.innerHTML = `<img src="${src}" alt="Vista ${i+1}" loading="lazy" style="width:100%;height:100%;object-fit:cover;">`;
        b.addEventListener('click', () => setMain(src));
        thumbs.appendChild(b);
      });

      addBtn.dataset.code = p.code;
      addBtn.dataset.qty = '1';
      qtyInp.addEventListener('input', () => {
        const q = Math.max(1, parseInt(qtyInp.value || '1', 10));
        qtyInp.value = q;
        addBtn.dataset.qty = String(q);
      });

      const relacionados = PRODUCTS_HH
        .filter(x => x.categoriaId === p.categoriaId && x.code !== p.code)
        .slice(0, 5);

      relatedGrid.innerHTML = '';
      relacionados.forEach(r => {
        const a = document.createElement('a');
        a.className = 'related-card';
        a.href = `./producto.html?code=${r.code}`;
        a.style.cssText = 'display:grid;gap:.4rem;padding:.7rem;border:1px solid var(--border);border-radius:12px;background:var(--surface);';
        a.innerHTML = `
          <div class="thumb" style="aspect-ratio:4/3;border-radius:10px;overflow:hidden;border:1px solid var(--border);">
            <img src="${r.imagen}" alt="${r.nombre}" style="width:100%;height:100%;object-fit:cover;">
          </div>
          <span class="title" style="font-weight:700;">${r.nombre}</span>
          <div class="rating-row" title="${(r.rating ?? 0).toFixed(1)} de 5">
            <span class="star-rating" style="--rating:${r.rating ?? 0}"></span>
            <span>${(r.rating ?? 0).toFixed(1)} Â· ${r.reviews ?? 0}</span>
          </div>
          <span class="price" style="font-weight:700;">${fmtCLP(r.precioCLP)}</span>
        `;
        relatedGrid.appendChild(a);
      });
    }
  </script>
</body>
</html>
